<Project ToolsVersion="4.0" DefaultTargets="Compile" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <Import Project="Tools\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"/>

    <PropertyGroup>
        <Version>0.0.0.0</Version>		
    </PropertyGroup>
	
	<PropertyGroup>
		<OutDir>OutDir\$(Configuration)</OutDir>
	</PropertyGroup>

	<PropertyGroup>
		<ZipDir>OutDir\Zip</ZipDir>
	</PropertyGroup>
	
	<PropertyGroup>
		<NuGet>Tools\NuGet\NuGet.exe</NuGet>
		<NuGetPackageDir>OutDir\NuGetPackage</NuGetPackageDir>
	</PropertyGroup>
	
    <PropertyGroup>
        <Thrift>packages\Thrift.0.7\tools\thrift-0.7.0.exe</Thrift>
        <ThriftInput>Apache.Cassandra\cassandra.thrift</ThriftInput>
        <ThriftOutput>Apache.Cassandra</ThriftOutput>
    </PropertyGroup>
	
    <PropertyGroup>
        <ILMerge>Tools\ILMerge\ILMerge.exe</ILMerge>
        <CassandraSharpAssembly>CassandraSharp\bin\$(Configuration)\CassandraSharp.dll</CassandraSharpAssembly>
        <ApacheCassandraAssembly>Apache.Cassandra\bin\$(Configuration)\Apache.Cassandra.dll</ApacheCassandraAssembly>
        <ThriftAssembly>packages\Thrift.0.7\lib\net35\Thrift.dll</ThriftAssembly>
        <KeyFile>cassandra-sharp.snk</KeyFile>
        <cassandra-sharpAssembly>$(OutDir)\cassandra-sharp.dll</cassandra-sharpAssembly>
    </PropertyGroup>

	<Target Name="GetDependencies">
		<Exec Command="$(NuGet) install packages.config -o packages" />
	</Target>

	<Target Name="Clean">
		<Exec Command="rmdir /q /s OutDir" />
		<MakeDir Directories="$(OutDir)" />
		<MakeDir Directories="$(ZipDir)" />
		<MakeDir Directories="$(NuGetPackageDir)" />
	</Target>
	
    <Target Name="GenerateAssemblyInfo">
        <AssemblyInfo CodeLanguage="CS" AssemblyVersion="$(Version)" AssemblyFileVersion="$(Version)" AssemblyInformationalVersion="$(Version)" OutputFile="cassandra-sharp-version.cs" />
    </Target>

    <Target Name="GenerateThrift">
        <Exec Command="$(Thrift) -o $(ThriftOutput) --gen csharp $(ThriftInput)" />
    </Target>

    <Target Name="Compile" DependsOnTargets="GetDependencies;GenerateAssemblyInfo;GenerateThrift">
        <MSBuild Projects="cassandra-sharp.sln" />
    </Target>

    <Target Name="Merge" DependsOnTargets="Clean">
        <Exec Command="$(ILMerge) /t:library /out:$(cassandra-sharpAssembly) /keyfile:$(KeyFile) $(CassandraSharpAssembly) $(ApacheCassandraAssembly)" />
    </Target>

	<Target Name="BuildZipPackage" DependsOnTargets="Compile;Merge">
        <ItemGroup>
            <ZipFilesCopy Include="$(cassandra-sharpAssembly)" />
            <ZipFilesCopy Include="$(ThriftAssembly)" />
        </ItemGroup>
		
		<Copy SourceFiles="@(ZipFilesCopy)" DestinationFolder="$(ZipDir)" />

        <ItemGroup>
            <ZipFiles Include="$(ZipDir)\**\*.*" />
        </ItemGroup>
		
        <Zip ZipFileName="OutDir\cassandra-sharp-bin-$(Version).zip" Files="@(ZipFiles)" WorkingDirectory="$(ZipDir)" ZipLevel="9" />
	</Target>
	
	<Target Name="BuildNuGetPackage" DependsOnTargets="Compile;Merge">
		<Copy SourceFiles="$(cassandra-sharpAssembly)" DestinationFolder="$(NuGetPackageDir)\lib\net35" />
		<Copy SourceFiles="cassandra-sharp.nuspec" DestinationFolder="$(NuGetPackageDir)" />
		<XmlPoke XmlInputPath="$(NuGetPackageDir)\cassandra-sharp.nuspec" Query="/package/metadata/version" Value="$(Version)" />
		<Exec Command="$(NuGet) pack $(NuGetPackageDir)\cassandra-sharp.nuspec -OutputDirectory OutDir" />
	</Target>
	
    <Target Name="GenerateVersion" DependsOnTargets="BuildZipPackage;BuildNuGetPackage">
    </Target>

</Project>